<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chollos 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ESTILOS ORIGINALES (conservados intactos) */
        body { margin: 0; font-family: 'Poppins', sans-serif; background: #1a1a1a; color: #f1f1f1; }
        header { background-color: #000; padding: 50px 20px 30px; text-align: center; }
        .title-3d { font-family: 'Orbitron', sans-serif; font-size: 3.5em; color: #ffd700; text-shadow: 2px 2px 0 #000, 4px 4px 5px #333; display: inline-block; border: 3px solid #000; padding: 20px 40px; border-radius: 20px; background: linear-gradient(145deg, #fff6b0, #ffd700); }
        .card-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; padding: 40px 20px; background-color: #eee; }
        .card { background: #f9f9f9; border-radius: 12px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); width: 100%; padding: 25px; border: 1px solid #ccc; color: #111; }
        .card h2 { font-size: 1.4em; color: #000; background: #ffd700; padding: 10px; border-radius: 8px; text-align: center; border: 2px solid #000; text-shadow: 1px 1px 2px #000; }
        .oferta { text-align: center; margin-top: 15px; }
        .oferta img { max-width: 100%; height: 200px; object-fit: contain; border-radius: 10px; border: 1px solid #ddd; background: #fff; padding: 5px; }
        .oferta h3 { font-size: 1em; margin: 10px 0; color: #333; }
        .oferta p { margin: 5px 0; color: #222; }
        .oferta a { display: inline-block; margin-top: 10px; padding: 8px 20px; background: #ffd700; color: #000; text-decoration: none; border-radius: 5px; font-weight: bold; border: 1px solid #000; }
        .error { color: red; padding: 10px; text-align: center; }
        .cargando { color: #666; text-align: center; }
        .qr { text-align: center; margin: 40px auto; }
        .qr img { width: 170px; border-radius: 12px; background: #fff; padding: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        footer { background: #ccc; text-align: center; font-size: 0.8em; color: #222; padding: 20px; margin-top: 60px; }
        
        /* BOTONES MEJORADOS */
        .btn-mas-menos {
            display: block;
            margin: 15px auto;
            padding: 10px 25px;
            background: linear-gradient(#ffd700, #e6c200);
            color: #000;
            border: 2px solid #000;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        .btn-mas-menos:hover {
            background: linear-gradient(#ffdf33, #ffd700);
        }
        .extra { display: none; }
        
        @media (max-width: 768px) {
            .card-container { grid-template-columns: 1fr; }
            .title-3d { font-size: 2em; padding: 10px 20px; }
        }
    </style>
</head>
<body>
    <header>
        <h1 class="title-3d">Chollos 2025</h1>
    </header>

    <div class="card-container">
        <div class="card">
            <h2>Chollos 2025</h2>
            <div id="general" class="cargando">Cargando novedades...</div>
        </div>
        <div class="card">
            <h2>Electr√≥nica</h2>
            <div id="electronica" class="cargando">Cargando productos...</div>
        </div>
        <div class="card">
            <h2>Deportes</h2>
            <div id="deportes" class="cargando">Cargando art√≠culos...</div>
        </div>
    </div>

    <div class="qr">
        <img src="/static/canal_qr.png" alt="QR Telegram" onerror="this.src='https://via.placeholder.com/170x170?text=Escanea+para+unirte'">
    </div>

    <footer>
        Ofertas actualizadas cada 15 minutos - ¬© Chollos 2025
    </footer>

    <script>
        // ========== FUNCI√ìN PRINCIPAL ==========
        async function cargarOfertas() {
            console.log("üîÑ Iniciando carga de ofertas...");
            
            const categorias = ['general', 'electronica', 'deportes'];
            
            for (const cat of categorias) {
                try {
                    console.log(`‚è≥ Cargando ${cat}...`);
                    const inicio = Date.now();
                    
                    const response = await fetch(`/api/${cat}?nocache=${Date.now()}`);
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    console.log(`üì¶ ${cat} recibi√≥:`, data.length, "productos");
                    
                    mostrarOfertas(cat, data);
                    
                    console.log(`‚úÖ ${cat} cargado en ${Date.now() - inicio}ms`);
                    
                } catch (error) {
                    console.error(`‚ùå Error en ${cat}:`, error);
                    document.getElementById(cat).innerHTML = `
                        <p class="error">Error temporal</p>
                        <button class="btn-mas-menos" onclick="cargarOfertas()">Reintentar</button>`;
                }
            }
        }

        // ========== MOSTRAR OFERTAS ==========
        function mostrarOfertas(categoria, datos) {
            const contenedor = document.getElementById(categoria);
            
            if (!datos || datos.error || datos.length === 0) {
                contenedor.innerHTML = `<p class="error">${
                    categoria === 'deportes' ? 'Pr√≥ximamente' : 
                    datos?.error || 'No hay ofertas'
                }</p>`;
                return;
            }

            // Primera oferta (siempre visible)
            let html = `
                <div class="oferta">
                    <img src="${datos[0].imagen}" 
                         alt="${datos[0].titulo}"
                         onerror="this.src='https://via.placeholder.com/300x200?text=Imagen+no+disponible'">
                    <h3>${datos[0].titulo}</h3>
                    <p><strong>${datos[0].precio}</strong> ${
                        datos[0].descuento ? `<span style="color:green">(-${datos[0].descuento}%)</span>` : ''
                    }</p>
                    <small>Actualizado: ${datos[0].fecha}</small>
                    <a href="${datos[0].url}" target="_blank" rel="noopener">Ver oferta</a>
                </div>`;

            // Ofertas adicionales (con botones)
            if (datos.length > 1) {
                html += `
                    <div class="extra" id="extra-${categoria}" style="display:none;">
                        ${datos.slice(1).map(item => `
                            <div class="oferta">
                                <img src="${item.imagen}" 
                                     alt="${item.titulo}"
                                     onerror="this.src='https://via.placeholder.com/300x200?text=Imagen+no+disponible'">
                                <h3>${item.titulo}</h3>
                                <p><strong>${item.precio}</strong> ${
                                    item.descuento ? `<span style="color:green">(-${item.descuento}%)</span>` : ''
                                }</p>
                                <small>Actualizado: ${item.fecha}</small>
                                <a href="${item.url}" target="_blank" rel="noopener">Ver oferta</a>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-mas-menos ver-mas" 
                            onclick="document.getElementById('extra-${categoria}').style.display='block'; this.style.display='none'; document.querySelector('#${categoria} .ver-menos').style.display='block'">
                        Ver m√°s (${datos.length - 1})
                    </button>
                    <button class="btn-mas-menos ver-menos" 
                            style="display:none;"
                            onclick="document.getElementById('extra-${categoria}').style.display='none'; this.style.display='none'; document.querySelector('#${categoria} .ver-mas').style.display='block'">
                        Ver menos
                    </button>`;
            }

            contenedor.innerHTML = html;
        }

        // ========== INICIAR ==========
        window.onload = () => {
            cargarOfertas();
            setInterval(cargarOfertas, 15000); // Actualizar cada 15 segundos
            console.log("üöÄ Aplicaci√≥n iniciada");
        };
    </script>
</body>
</html>
